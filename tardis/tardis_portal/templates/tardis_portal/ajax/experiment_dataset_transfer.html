{% if experiments %}
<form id="other-experiment-selection" class="form-horizontal">
  <fieldset>
    <div class="control-group">
      <label class="control-label" for="input01">Experiment</label>
      <div class="controls">
        <select name="experiment_id">
          {% for experiment in experiments %}
          <option value="{{experiment.id}}">{{experiment.title}}</option>
          {% endfor %}
        </select>
        <p class="help-text">
          Select an experiment, then drag and drop the datasets
        </p>
      </div>
    </div>
  </fieldset>
</form>

<div id="other-experiment-datasets"></div>

<script type="text/javascript">
var otherDatasetTiles;
(function() {
  var enableDragDrop = function() {
    // Context should be a MyTardis.DatasetTiles instance
    var datasetTiles = this;
    $(datasetTiles.el).find('.datasets').sortable({
      'connectWith': '.datasets',
      'dropOnEmpty': true,
      'helper': 'clone',
      'placeholder': 'thumbnail span6',
      'receive': _.bind(function(event, ui) {
        var datasetTile = ui.item.find('.dataset-tile').prop('view');
        this.addTile(datasetTile);
        ui.item.detach();
      }, datasetTiles)
    }).disableSelection();
    // We need the dataset columns to be roughly the same height, or else
    // there's no way to drag datasets across
    var ensureSimilarHeight = function() {
      // Remove min-height to get real height
      $('.datasets').css('min-height', '');
      // Select the maximum height
      var height = _.max(_.map($('.datasets'), function(v) {
        return $(v).height();
      }));
      // Set min-height to ensure that all columns are that high (min 100px)
      $('.datasets').css('min-height', Math.max(height, 100)+"px");
    };
    datasetTiles.on('tiles:rendered', ensureSimilarHeight);
    ensureSimilarHeight();
  };
  // Enable dragging for main tiles
  _.bind(enableDragDrop, datasetTiles)();

  function getDatasetsForExperiment(experimentId) {
    var datasets = new MyTardis.Datasets();
    datasets.experimentId = parseInt(experimentId),
    {# Careful! Remember Django replaces this first! #}
    // Substitute experiment ID to get collection
    datasets.url = Mustache.to_html("{{ url_pattern }}",
        { 'experiment_id': experimentId });

    var datasetTiles = new MyTardis.DatasetTiles({
      'id': "other-experiment-datasets",
      'collection': datasets,
      'el': $('#other-experiment-datasets').get(0)
    });

    datasets.fetch({});

    // Enable dragging for other tiles
    datasetTiles.on('tiles:rendered', enableDragDrop);

    return datasetTiles;
  }

  $('form#other-experiment-selection').submit(function(evt) {
    evt.preventDefault();
    var experimentId = $(this).find('[name="experiment_id"]').val();
    otherDatasetTiles = getDatasetsForExperiment(experimentId);
  });
  $('form#other-experiment-selection select').change(function(evt) {
    $(this).parents('form').submit();
  });

  // Load initial data
  $('form#other-experiment-selection').submit();
})();
</script>

{% else %}
<div class="alert">
  <p>You do not currently own any other experiments.</p>
</div>
{% endif %}
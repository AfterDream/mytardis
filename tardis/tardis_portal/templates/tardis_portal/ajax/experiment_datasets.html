{% load basiccomparisonfilters %}
{% load url from future %}
{% load capture %}
{% load uploadify_tags %}
{% load static from staticfiles %}

{% block script %}

<script type="text/javascript">
  function disableEnterKey(e) {
    var key;
    if (window.event) {
      key = window.event.keyCode; //IE
    } else {
      key = e.which; //firefox
    }
    return (key != 13);
  }

  $('.filename_search').live(
      'keyup',
      function(e) {
        e.preventDefault();
        if (e.keyCode == 13) {
          var dataset_id = $(this).siblings('.dataset_id').val();

          $(this).parents('.datafile_list').load(
              "/ajax/datafile_list/" + dataset_id + "/?filename="
                  + $(this).val());
        }
      });

  $("input[name$='show_search']")
      .live(
          'click',
          function() {
            var show_search = $(this).val();
            $('.datafile_list')
                .each(
                    function() {
                      var dataset_id = $(this).find('.dataset_id').val();
                      var params = [];
                      var toggle = $(this).siblings('.datafile_list_toggle');
                      var loadHtml = '<img src="{% static 'images/ajax-loader.gif' %}"/><br />';

                      html = $(this).siblings('.datafile_list_toggle').attr(
                          'href')
                      if (show_search == "matches") {
                        html = html + '&limit=true'
                      } else {
                        html = html.replace('&limit=true', '')
                      }
                      toggle.attr('href', html);

                      if (toggle.hasClass('files_shown')) {
                        $(this).html(loadHtml);
                        $(this).load(html);
                      }
                    });
            if ($(this).val() == "matches") {
              $(".dataset").hide();
              $(".search_match").show();
              $(".datafile_match").show();
            } else {
              $(".dataset").show();
            }
          });


  $("#uploadify").live("allUploadsComplete", function(e, data){
      // refresh datafile list
      var dataset_id = $(this).attr('data-dataset_id');
      $(this).parents('.datafile_list').load("/ajax/datafile_list/" + dataset_id + "/");
  });

  $('.upload_files_link').live('click', function(evt) {
      var dataset_id = $(this).attr('data-dataset_id');
      var modal = $('#modal-upload-files');


      // clear the upload files container
      modal.find('.modal-body').html('');
      modal.find('.loading-placeholder').show();
      modal.modal('show');

      modal.find('.modal-body')
           .load("/ajax/upload_files/" + dataset_id + "/", function() {
              modal.find('.loading-placeholder').hide();
              modal.find('#uploadify').on('allUploadsComplete', function(data) {
                modal.modal('hide');
              })
            });
  });

  $('.import_staging_files_link').live('click', function(evt) {
      var dataset_id = $(this).attr('data-dataset_id');
      var modal = $('#modal-upload-files');

      // clear the upload files container
      modal.find('.modal-body').html('');
      modal.find('.loading-placeholder').show();
      modal.modal('show');

      modal.find('.modal-body')
           .load("/ajax/import_staging_files/" + dataset_id + "/", function() {
              modal.find('.loading-placeholder').hide();
            });
  });
</script>

{% endblock %}

{% capture as action_bar %}
  {% if has_download_permissions or has_write_permissions %}
  <div>
    {% if has_write_permissions %}
    <a class="add-dataset btn btn-primary pull-right"
       href="{% url 'tardis.tardis_portal.views.add_dataset' experiment.id %}">
      <i class="icon-plus"></i>
      Add new
    </a>
    {% endif %}

    {% if has_download_permissions %}
      <button type="submit" class="btn btn-primary">
        <i class="icon-download-alt"></i>
        Download Selected
      </button>
    {% endif %}
  </div>
  <br />
  {% endif %}
{% endcapture %}

<div id="experiment_datasets">
  {% if highlighted_datasets or file_matched_datasets %}
  <form name="search_select_form" id="search_form" method="post" action="">
    <div><label><input type="radio" name="show_search" value="all" checked>Show all</label></div>
    <div><label><input type="radio" name="show_search" value="matches">Search matches only</label></div>
  </form>
  {% endif %}
  <form method="POST" action="{% url 'tardis.tardis_portal.download.download_datafiles' %}" target="_blank">
    <input type="hidden" name="expid" value="{{experiment.id}}"/>

    {{ action_bar }}
    <ul id="datasets" class="thumbnails">
      {% for dataset in datasets %}
      <li class="dataset span6">
        {% url 'tardis.tardis_portal.views.view_dataset' dataset.id as dataset_url %}
        <div class="dataset-tile thumbnail">
          <div class="pull-left" style="margin-right: 10px">
            <div style="text-align: center; font-size: 32px">
              <i class="icon-folder-open"></i>
            </div>
            <br/>
            <label class="badge badge-info "
                   style="display: block; margin-left: auto; margin-right: auto"
                   for="dataset-checkbox-{{dataset.id}}">
              <i class="icon-download-alt"></i>
              <input id="dataset-checkbox-{{dataset.id}}"
                     name="dataset"
                     type="checkbox"
                     class="dataset_checkbox"
                     style="display: inline"
                     value="{{dataset.id}}" />
            </label>
          </div>
          <div class="pull-left" style="margin-right: 10px">
          {% if has_download_permissions %}
            {% for datafile in dataset.get_images|slice:":1" %}
              {% url 'tardis.tardis_portal.iiif.download_image' datafile_id=datafile.id region='full' size='100,' rotation=0 quality='native' format='jpg' as thumbnail %}
                <img src="{{ thumbnail }}" onerror="$(this).hide()"/>
            {% empty %}
                <canvas style="width: 100px"></canvas>
            {% endfor %}
          {% endif %}
          </div>
          <p>
            <a href="{{ dataset_url }}">
            {% if dataset.description %}
              {{ dataset.description|safe }}
            {% else %}
              <em>Dataset #{{dataset.id}}</em>
            {% endif %}
            </a>
          </p>
          <div style="clear: both"></div>
        </div>
      </li>
      {% endfor %}

    {% if datasets.count|gt:4 %}
    {{ action_bar }}
    {% endif %}
    </ul>
  </form>
</div> <!-- experiment_datasets -->


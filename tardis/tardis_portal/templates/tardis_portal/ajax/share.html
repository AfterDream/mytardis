{% load static from staticfiles %}
{% load url from future %}
{% load experiment_tags %}
{% block script %}
<script type="text/javascript">
$('.public_access_link').live('click', function(evt) {
    var experiment_id = $(this).attr('data-experiment_id');
    var modal = $('#modal-public-access');


    modal.find('.modal-body').html('');
    modal.find('.loading-placeholder').show();
    modal.modal('show');

    modal.find('.modal-body')
         .load("/ajax/experiment/" + experiment_id + "/rights", function() {
            modal.find('.loading-placeholder').hide();
            $('#legal-section').hide();
        });
       
});


$('#modal-public-access').bind('hidden', function () {
  $('.tab-pane').trigger('experiment-change');
});


//beginswith, endswith
String.prototype.beginsWith = function(t, i) { if (i==false) { return
(t == this.substring(0, t.length)); } else { return (t.toLowerCase()
== this.substring(0, t.length).toLowerCase()); } }

String.prototype.endsWith = function(t, i) { if (i==false) { return (t
== this.substring(this.length - t.length)); } else { return
(t.toLowerCase() == this.substring(this.length -
t.length).toLowerCase()); } }


$('.share_link').live('click', function(evt) {
    var experiment_id = $(this).attr('data-experiment_id');
    var modal = $('#modal-share');


    modal.find('.modal-body').html('');
    modal.find('.loading-placeholder').show();
    modal.modal('show');

    modal.find('.modal-body')
         .load("/experiment/control_panel/" + experiment_id + "/access_list/user/", function() {
            modal.find('.loading-placeholder').hide();

               $("#id_entered_user").keypress(function() {
                   // Reset autocomplete user when typing in the user edit field.
                   $(this).siblings("#id_autocomp_user").val('');
                   $(this).siblings("#id_authMethod").attr('disabled', '');
               });
               // Load user list and activate field autocompletion
               $.ajax({
                 'dataType': 'json',
                 'url': '/ajax/user_list/',
                 'success': function(users) {
                   $("#id_entered_user").autocomplete({
                       'source': _.bind( function(query, callback) {
                         var authMethod = $("#id_authMethod").val();
                         callback(
                             userAutocompleteHandler(
                                 query.term, this.users, authMethod));
                       }, { 'users': users })
                   });
                 }
               });


             $("#user.form_submit").unbind('click');
             $("#user.form_submit").click(function(event) {
               event.preventDefault();
               var entered_user = $(this).siblings("#id_entered_user").val();
               var autocomp_user = $(this).siblings("#id_autocomp_user").val();
               if (autocomp_user != "") {
                 // Use the details from the autocomplete.
                 autocomp_user = autocomp_user.split(":");
                 var username = autocomp_user[0];
                 var authMethod = autocomp_user[1];
               } else {
                 // Autocomplete failed. Use the entered username as-is.
                 var username = entered_user;
                 var authMethod = $(this).siblings("#id_authMethod").val();
               }
               var experiment_id = $(this).siblings(".experiment_id").val();
               var users_div = $(this).parents('.access_list1').children('.users');
               var canRead = $(this).siblings(".canRead").is(':checked');
               var canWrite = $(this).siblings(".canWrite").is(':checked');
               var canDelete = $(this).siblings(".canDelete").is(':checked');
               var permissions = '/?authMethod=' + authMethod + '&canRead=' + canRead + '&canWrite=' + canWrite + '&canDelete=' + canDelete;
               action = '/experiment/control_panel/' + experiment_id +
                 '/access_list/add/user/' + username + permissions;

               $.ajax({
                 'async': false,
                 'global': true,
                 type: "GET",
                 url: action,
                 success: function(data) {
                     users_div.hide().append(data).fadeIn();
                     // todo this is a duplicate function..
                     $(".remove_user").unbind('click');
                     $(".remove_user").click(function() {
                       var href = $(this).attr("href");
                       remove_user = $(this);
                       $.ajax({
                         'async': false,
                         'global': false,
                         'url': href,
                         'success': function (data) {
                           val = data;
                           if(val == "OK") {
                             remove_user.fadeOut(300, function(){ remove_user.parents('.access_list_user').remove(); });
                           }
                           else { alert(val); }
                         }
                       }); // end ajax
                       return false;
                     }); // end remove user
                   },
                 error: function(data) { alert('Error adding user'); }
               });
               return false;
             });

             $(".remove_user").unbind('click');
             $(".remove_user").click(function() {

               var href = $(this).attr("href");
               remove_user = $(this);
               $.ajax({
                 'async': false,
                 'global': false,
                 'url': href,
                 'success': function (data) {
                   val = data;
                   if(val == "OK") {
                     remove_user.fadeOut(300, function(){ remove_user.parents('.access_list_user').remove(); });
                   }
                   else { alert(val); }
                 }
               }); // end ajax

               return false;
             }); // end remove user
            });            
       
});

$('#modal-share').bind('hidden', function () {
  $('.tab-pane').trigger('experiment-change');
});

$('.copylink').live('click', function(evt)
{
    $(this).focus();
    $(this).select();
});

// user access list
$(document).ready(function() {
  var $target_user = $("#experiment_user_list");
  $target_user.html(loadingHTML + "</br>");
  var href = "/experiment/control_panel/{{experiment.id}}/access_list/user/readonly/"
  $target_user.load(href);
  
  var $target_group = $("#experiment_group_list");
  $target_group.html(loadingHTML + "</br>");
  var href = "/experiment/control_panel/{{experiment.id}}/access_list/group/readonly/"
  $target_group.load(href);  
 });
</script>
{% endblock %}
{% block content %}

<!-- Scripts -->
{% load mustachejs %}
{% mustachejs "tardis_portal/license_selector" %}
{% mustachejs "tardis_portal/rights_update_message" %}
{% mustachejs "tardis_portal/ajax_error" %}

<!-- public access modal !-->
<div class="modal hide fade" id="modal-public-access">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h1 class="title">Public Access</h1>
  </div>

  <div class="loading-placeholder" style="display: none">
    <p>Please wait... <img src="{% static 'images/ajax-loader.gif'%}" alt="loading" /></p>
  </div>

  <div class="modal-body"></div>

</div>

<!-- sharing modal !-->
<div class="modal hide fade" id="modal-share">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">&times;</a>
    <h1 class="title">Public Access</h1>
  </div>

  <div class="loading-placeholder" style="display: none">
    <p>Please wait... <img src="{% static 'images/ajax-loader.gif'%}" alt="loading" /></p>
  </div>

  <div class="modal-body">
  </div>

</div>

<div class="sharing-sections">
    <div class="sharing-section public-access">
    <h3>Public Access</h3>
        <p>
            <dl>
              <dt>Current Public Access Settings</dt>
              <dd style="padding-top: 5px;">
                {{ experiment|experiment_public_access_badge }}
              </dd>
            </dl>            
            <dl>
              <dt>Current License</dt>
              <dd>
                {% if experiment.license_id %}
                  <div class="row-fluid">
                    <div class="span6">
                      This experiment data is licensed under
                      <a rel="license"
                         property="dc:license"
                         href="{{ experiment.license.url }}">
                        {{ experiment.license.name }}</a>.
                    </div>
                    {% if experiment.license.image_url != None %}
                    <div class="span6">
                      <img src="{{ experiment.license.image_url }}"/>
                    </div>
                    {% endif %}
                  </div>
                {% else %}
                  <abbr title="All rights reserved">
                    Unspecified
                  </abbr>
                {% endif %}
              </dd>
            </dl>
        </p>
        <a data-experiment_id="{{experiment.id}}" class="public_access_link btn btn-primary" title="Change">
          <i class="icon-cog"></i>
          Change
        </a>
    </div>
    <hr/>
    <div class="sharing-section sharing">
    <h3>User and Group Sharing</h3>
    <p>Users who have a share in this experiment:</p>
    <div id="experiment_user_list"/>
    <p>Groups who have a share in this experiment:</p>
    <div id="experiment_group_list"/>
        <a data-experiment_id="{{experiment.id}}" class="share_link btn btn-primary" title="Change">
            <i class="icon-share"></i>
            Change
        </a>        
    </div>
    <hr/>
    <div class="sharing-section sharing">
    <h3>Links</h3>
    <p>This experiment can be accessed by everybody with the link below:
        <input class="copylink span9" value="http://www.mytardis.org/XOJWE25"
            readonly="readonly"></p>
    <br/>
    <p>Temporary access links exist for this experiment:</p>
    <table class="table table-striped">
        <tr>
            <tr>
                <th style="width: 60%;">
                    Link
                </th>
                <th>
                    Expiry
                </th>
                <th>
                    Remove
                </th>                
            </tr>
            <td>
                <input class="copylink span12" value="http://www.mytardis.org/XOJWE25"
                    readonly="readonly"
                    >  
            </td>
            <td>
                29th July, 2012
            </td>  
            <td>
                [x]
            </td>            
        </tr>
        <tr>
            <td>
                <input class="copylink span12" value="http://www.mytardis.org/XOJWE25"
                    readonly="readonly"
                    > 
            </td>
            <td>
                29th July, 2012
            </td> 
            <td>
                [x]
            </td>                                 
        </tr>      
    </table>
    <button type="submit" class="btn btn-primary">
        Create New Temporary Link      
    </button>
    </div>
    <hr/>
    <div class="sharing-section sharing">
    <h3>Feeds</h3>
    <p>Data feeds for this experiment exist:</p>
    <table class="table table-striped">
        <tr>
            <tr>
                <th>Name</th>
                <th style="width: 60%;">
                    Link
                </th>               
            </tr>
                <td>OAI-DC</td>            
                <td>
                    <input class="copylink span12" value="http://www.mytardis.org/XOJWE25"
                        readonly="readonly"
                        >  
                </td>         
        </tr>
        <tr>
            <td>RIF-CS</td>
            <td>
                <input class="copylink span12" value="http://www.mytardis.org/XOJWE25"
                    readonly="readonly"
                    > 
            </td>                               
        </tr>      
    </table>
    </div>      
</div>

{% endblock %}


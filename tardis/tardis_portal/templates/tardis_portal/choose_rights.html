{% extends "tardis_portal/portal_template.html" %}

{% block script %}
{{block.super}}
{% load mustachejs %}
{% mustachejs "tardis_portal/license_selector" %}
<script type="text/javascript">
var populateLicenseOptions = function(public_access) {
  $.ajax({
    url: '/ajax/license/list?public_access='+public_access,
    dataType: 'json',
    success: function(licenses) {
      $('#license-options').empty();
      _(licenses).each(function (license) {
        $('#license-options').append(
            Mustache.to_html(
                Mustache.TEMPLATES['tardis_portal/license_selector'],
                license, Mustache.TEMPLATES)
        );
        var selectedOption = $('.license-option input[value="'
                                                      +$('form input[name="license"]').val()
                                                      +'"]')
                                                      .parents('.license-option');
        selectedOption.find('.use-button').prop('disabled', true);
        selectedOption.find('.use-button').text('Selected');
      });
    }
  });
};
</script>
{% endblock %}

{% block content %}
<div class="page-header">
	<h1>Choose Public Access and Licensing</h1>
</div>

{% if not submit %}
<p>
  <strong>Experiment Name:</strong> {{ experiment.title }}
</p>
<form action="." method="post" class="form-horizontal">
  {% load bootstrap %}
  {{ form|bootstrap }}

  <div id="license-options"></div>
  <script type="text/javascript">
  $(document).on('click', '#license-options .use-button', function(evt) {
    // Get the selected ID from hidden input
    var id = $(this).parents('.license-option').find('input.license-id').val();
    // Set the licence ID for the form
    $(this).parents('form').find('input[name="license"]').val(id);
    // Enable all buttons, then disable the one we selected
    $(this).parents('#license-options')
           .find('.use-button')
           .prop('disabled', false);
    $(this).prop('disabled', true);
    $(this).text('Selected');
    // Submit form
    $(this).parents('form').submit();
  });
  </script>

  <script type="text/javascript">
  $('select[name="public_access"]').change(function() {
    populateLicenseOptions($(this).val());
  });
  populateLicenseOptions($('select[name="public_access"]').val());
  </script>
</form>
{% else %}
<h2>License Chosen</h2>
<a href="{% url tardis.tardis_portal.views.view_experiment experiment.id %}">Go back to your experiment.</a>
{% endif %}
{% endblock %}

